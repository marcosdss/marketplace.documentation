---
slug: release-20240514
authors: [gustavo]
tags: [spike]
---

# Spike - LIONS 390

## Problema no "Retirada em loja" com fraude

## 1. Introdução

De forma resumida, recebemos a informação de que estamos tendo problemas em pedido feitos pelo site e-commerce, onde o cliente faz o pedido normal e retira em loja,
depois ele contesta o pedido junto ao cartão de crédito e o Oba tem que devolver o dinheiro.

Desejamos que seja feito um estudo de possibilidades técnicas, para que possamos alterar a comunicação em algumas etapas do pedido, que são:
- **Modal de regionalização** → a principio será somente alteração de textos nessa etapa, informando sobre o novo processo de retirada em loja;
- **Checkout** → criação de pop up informativo, para quando o cliente selecionar a opção retirar (seja na etapa da regionalização ou no checkout mesmo) exibirmos uma mensagem,
a nível informativo somente, sobre o novo processo de retirada em loja. Se possível, utilizar exemplo de pop up desenvolvido para notificar sobre valor mínimo de pedido;
- **Comunicação (e-mail transacional somente de cliente que selecionou a retirada em loja)** → verificar se é possível alterar no e-mail transacional de retirada em loja,
sobre este novo processo de retirada em loja.

## 2. É possível realizar essas alterações?

### 2.1. Modal de regionalização

No modal de regionalização, é viável realizar a alteração sugerida para a retirada em loja. Podemos ajustar os textos para comunicar de forma mais clara aos clientes
sobre o novo processo de retirada em loja.

### 2.2. Checkout

:::danger
Não é recomendado realizar qualquer tipo de alteração no checkout. O checkout é uma das partes mais sensíveis e cruciais de todo o site. É onde os clientes efetuam o pagamento de
suas compras e fornecem dados sensíveis.

Alterações no checkout podem resultar em problemas futuros e possíveis instabilidades.
:::

Apesar do aviso, caso ainda deseje prosseguir com a criação do modal para a opção de **Retirada em loja**, é possível fazê-lo. Podemos criar um modal apenas para a exibição do
texto informativo.

### 2.3. Comunicação (e-mail transacional somente de cliente que selecionou a retirada em loja)

Sim, é possível adicionar um novo texto aos e-mails transacionais que incluem a opção de retirada em loja. Atualmente, alguns e-mails já contêm essa informação e seria
possível adicionar uma nova mensagem exclusivamente para a opção de retirada em loja, sem que ela apareça quando o cliente selecionar a entrega em casa.

Abaixo está a lista de e-mails que atualmente apresentam informações sobre a retirada em loja:

- [Pedido realizado](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-new-order)
- [Pagamento aprovado](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-payment-approved)
- [Pagamento aprovado e pronto para entrega/retirada](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-order-invoiced?page=1&per_page=20)
- [Shipping update](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-order-shipping-update?page=1&per_page=20)
- [Pedido entregue](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-order-shipping-finished)


## 3. Diretrizes para o desenvolvimento

### 3.1. Modal de regionalização

Para a parte do modal de regionalização podemos realizar as alterações dentro do repositório [oba.regionalization-components](https://github.com/ObaHortifrutiDeveloper/oba.regionalization-components).

Para modificar apenas os textos da opção "Retirar em loja", localize o arquivo  `react\components\ModalCep\DeliveryMethods\Pickupoints.tsx`. Abaixo deixarei um exemplo de como adiocionar um texto no modal:

```js
<div className="flex justify-between items-top">
  <h5 className={`${handles.deliverInTitle}`}>Retirada em loja agendada, com base nos horários e datas disponíveis, antes do pagamento da compra</h5>
</div>
<div className="flex justify-between items-top">
  <h5 className={`${handles.deliverInTitle}`}>Lorem ipsum dolor sit amet consectetur adipisicing elit. Similique at hic optio? Temporibus, culpa perferendis doloremque, vel dolore in beatae deleniti debitis eaque, deserunt consectetur! Dolore corporis temporibus quaerat id.</h5>
</div>
```

### 3.2. Checkout

Para adicionar um modal com uma mensagem informativa apenas quando o cliente selecionar a opção de "Retirar em loja", podemos acessar o arquivo `src\pages\shipping\postalCode\index.ts`.

Dentro desse arquivo, existe uma função que monitora o `orderForm` para verificar possíveis alterações. Dentro dessa função, podemos adicionar uma condição `if` para
apresentar um modal quando a opção selecionada for "Retirar em loja".

Podemos fazer isso da seguinte forma:

```ts
$(window).on('orderFormUpdated.vtex', function () {
    if (vtexjs.checkout.orderForm?.shippingData?.selectedAddresses[0]?.postalCode) {
      removeStoragedCustomPostalCode()
    }

    insertPostalCodeInput(isObserverNeeded)

    setInputErrorClass()

    const selectedDeliveryChannel = vtexjs.checkout.orderForm?.shippingData?.logisticsInfo[0]?.selectedDeliveryChannel

    if (selectedDeliveryChannel === 'pickup-in-point') {
      const modalStructure = `
      <div class="minimum-modal-container">
        <p>Teste</p>
        <a href="/checkout/#/shipping" id="close-modal-container">
          <img src="/arquivos/CloseButton.png" alt="Fechar Modal" />
        </a>
      </div>
      `
      $('body').append(modalStructure);

      $(document).on('click', '#close-modal-container', function (event) {
        event.preventDefault();
        $('.minimum-modal-container').remove();
      });

      $(document).on('click', function (event) {
        if (!$(event.target).closest('.minimum-modal-container').length && $('.minimum-modal-container').length > 0) {
          $('.minimum-modal-container').remove();
        }
      });
    }
  })
```

### 3.3. Comunicação (e-mail transacional somente de cliente que selecionou a retirada em loja)

Atualmente, utilizamos o repositório [oba.emails](https://github.com/ObaHortifrutiDeveloper/oba.emails) para visualizar e realizar alterações nos e-mails transacionais
existentes no Oba. Embora esse repositório seja útil para manter os códigos dos e-mails, as alterações nos templates podem ser feitas diretamente no
[admin](https://obahortifruti.myvtex.com/admin/message-center/#/templates) da VTEX.

Se surgir a necessidade de adicionar um novo texto aos e-mails transacionais que contenham a informação de retirada em loja, podemos seguir o exemplo abaixo:

> Adicione ao e-mail que deseja algo como o código abaixo:

```hbs
{{#eq selectedDeliveryChannel "pickup-in-point"}}
  <p style="margin: 0; font-size: 14px;color:#555;font-weight:400; box-sizing: border-box;">
    Retirada</p>
  {{else}}
    <p style="margin: 0; font-size: 14px;color:#555;font-weight:400; box-sizing: border-box;">
      Entrega</p>
{{/eq}}
```

Os e-mais que talvez precisemos alterar são os seguintes:
- [Pedido realizado](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-new-order) - emails\templates\order-confirmation.hbs
- [Pagamento aprovado](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-payment-approved) - emails\templates\payment-approved.hbs
- [Pagamento aprovado e pronto para entrega/retirada](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-order-invoiced?page=1&per_page=20) - emails\templates\order-invoiced.hbs
- [Shipping update](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-order-shipping-update?page=1&per_page=20) - emails\templates\shipping-update.hbs
- [Pedido entregue](https://obahortifruti.myvtex.com/admin/message-center/#/templates/vtexcommerce-order-shipping-finished) - emails\templates\order-delivered.hbs

## 4. Repositórios Usados para Testes

Para essa spike foram utilizados os repositórios:
- [oba.regionalization-components](https://github.com/ObaHortifrutiDeveloper/oba.regionalization-components)
- [oba.emails](https://github.com/ObaHortifrutiDeveloper/oba.emails)
- [oba.checkout](https://github.com/ObaHortifrutiDeveloper/oba.checkout)
